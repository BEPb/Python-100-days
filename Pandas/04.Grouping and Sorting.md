Grouping and Sorting
###Группировка и сортировка
Вступление¶
Карты позволяют нам преобразовывать данные в DataFrame или Series по одному значению для всего столбца. Однако 
часто мы хотим сгруппировать наши данные, а затем сделать что-то конкретное для группы, в которой они находятся.

Как вы узнаете, мы делаем это с помощью операции groupby (). Мы также рассмотрим некоторые дополнительные темы, 
такие как более сложные способы индексирования ваших DataFrames, а также способы сортировки данных.

Чтобы начать упражнение по этой теме, щелкните здесь.

###Групповой анализ
До сих пор мы активно использовали функцию value_counts(). Мы можем воспроизвести то, что делает value_counts(), 
выполнив следующие действия:
```python
import pandas as pd
reviews = pd.read_csv("../input/wine-reviews/winemag-data-130k-v2.csv", index_col=0)
pd.set_option("display.max_rows", 5)

reviews.groupby('points').points.count()
```
groupby() создала группу обзоров, в которых указанным винам присвоены одинаковые баллы. Затем для каждой из этих 
групп мы брали столбец points() и подсчитывали, сколько раз он появлялся. value_counts() - это просто ярлык для 
этой операции groupby().

Мы можем использовать любую из суммирующих функций, которые мы использовали ранее с этими данными. Например, чтобы 
получить самое дешевое вино в каждой категории баллов, мы можем сделать следующее:
```python
reviews.groupby('points').price.min()
```
Вы можете думать о каждой группе, которую мы генерируем, как о части нашего DataFrame, содержащей только данные с 
совпадающими значениями. Этот DataFrame доступен нам напрямую с помощью метода apply(), и затем мы можем 
манипулировать данными любым способом, который сочтем нужным. Например, вот один из способов выбрать имя первого 
проверенного вина из каждой винодельни в наборе данных:
```python
reviews.groupby('winery').apply(lambda df: df.title.iloc[0])
```
Для еще более детального управления вы также можете сгруппировать по нескольким столбцам. Например, вот как мы 
выбираем лучшее вино по стране и провинции:
```python
reviews.groupby(['country', 'province']).apply(lambda df: df.loc[df.points.idxmax()])
```
Еще один метод groupby(), о котором стоит упомянуть, - это agg (), который позволяет вам одновременно запускать 
кучу различных функций в вашем DataFrame. Например, мы можем создать простую статистическую сводку набора данных 
следующим образом: 
```python
reviews.groupby(['country']).price.agg([len, min, max])
```
Эффективное использование groupby () позволит вам делать много действительно мощных вещей с вашим набором данных.

###Мультииндексы
Во всех примерах, которые мы видели до сих пор, мы работали с объектами DataFrame или Series с индексом с одной 
меткой. groupby() немного отличается тем, что, в зависимости от выполняемой нами операции, иногда приводит к так 
называемому мультииндексу.

Мультииндекс отличается от обычного индекса тем, что он имеет несколько уровней. Например:
```python
countries_reviewed = reviews.groupby(['country', 'province']).description.agg([len])
countries_reviewed
```
определим тип - Мультииндекс
```python
mi = countries_reviewed.index
type(mi)
```
У мультииндексов есть несколько методов работы с их многоуровневой структурой, которые отсутствуют у одноуровневых 
индексов. Им также требуются два уровня меток для получения значения. Работа с мультииндексным выводом - обычная 
проблема для пользователей, плохо знакомых с pandas.

Сценарии использования мультииндекса подробно описаны вместе с инструкциями по их использованию в разделе 
MultiIndex / Advanced Selection документации pandas.

Однако, как правило, многоиндексный метод, который вы будете использовать чаще всего, - это метод возврата к 
обычному индексу, метод reset_index ():
```python
countries_reviewed.reset_index()
```
###Сортировка¶
Еще раз посмотрев на country_reviewed, мы увидим, что при группировке данные возвращаются в порядке индекса, а не в 
порядке значений. То есть при выводе результата groupby порядок строк зависит от значений в индексе, а не в данных.

Чтобы получить данные в нужном порядке, мы можем сами их отсортировать. Для этого удобен метод sort_values ().
```python
countries_reviewed = countries_reviewed.reset_index()
countries_reviewed.sort_values(by='len')
```
sort_values () по умолчанию использует сортировку по возрастанию, где сначала идут самые низкие значения. Однако в 
большинстве случаев нам нужна сортировка по убыванию, при которой сначала идут более высокие числа. Это происходит так:
```python
countries_reviewed.sort_values(by='len', ascending=False)
```
Для сортировки по значениям индекса используйте сопутствующий метод sort_index(). Этот метод имеет те же аргументы 
и порядок по умолчанию:
```python
countries_reviewed.sort_index()
```
Наконец, знайте, что вы можете сортировать по более чем одному столбцу за раз:
```python
countries_reviewed.sort_values(by=['country', 'len'])
```
###Вступление¶
В этих упражнениях мы применим групповой анализ к нашему набору данных.

Запустите ячейку кода ниже, чтобы загрузить данные перед выполнением упражнений.
###Упражнения
1. Кто наиболее часто упоминает винные рецензенты в наборе данных? Создайте серию, индекс которой является 
   категорией taster_twitter_handle из набора данных, и чьи значения подсчитывают, сколько отзывов написал каждый человек.
```python
reviews_written = reviews.groupby('taster_twitter_handle').size()
# or
# reviews_written = reviews.groupby('taster_twitter_handle').taster_twitter_handle.count()
```
2. Какое лучшее вино я могу купить за определенную сумму денег? Создайте серию, индекс которой - это цены на вино, а 
значения - максимальное количество баллов, которое так дорого стоит вино, которое было дано в обзоре. Отсортируйте 
 значения по цене в порядке возрастания (чтобы 4,0 доллара было вверху, а 3300,0 доллара внизу). 
```python
best_rating_per_price = reviews.groupby('price')['points'].max().sort_index()
```
3. Каковы минимальные и максимальные цены на каждый сорт вина? Создайте DataFrame, индекс которого является 
    категорией разнообразия из набора данных, а значениями - их минимальным и максимальным значениями.
```python
price_extremes = reviews.groupby('variety').price.agg([min, max])
```
4. Какие сорта вина самые дорогие? Создайте переменную sorted_variversity, содержащую копию фрейма данных из 
предыдущего вопроса, где сорта сортируются в порядке убывания по минимальной цене, а затем по максимальной цене 
   (чтобы разорвать связи).
```python
sorted_varieties = price_extremes.sort_values(by=['min', 'max'], ascending=False)
```
5. Создайте серию, индекс которой - рецензенты, а значения - средний балл, присвоенный этим рецензентом. Подсказка: 
вам понадобятся столбцы taster_name и points.
```python
reviewer_mean_ratings = reviews.groupby('taster_name').points.mean()
```
Есть ли существенные различия в средних оценках, присвоенных разными рецензентами? Запустите ячейку ниже, чтобы 
использовать метод describe (), чтобы просмотреть сводку диапазона значений.

6. Какое сочетание стран и сортов наиболее распространено? Создайте серию, индекс которой является парным 
множеством индексов {страна, разнообразие}. Например, пино нуар, произведенное в США, должно соответствовать 
 {"США", "Пино Нуар"}. Отсортируйте значения в Серии в порядке убывания в зависимости от количества вин.
```python
country_variety_counts = reviews.groupby(['country', 'variety']).size().sort_values(ascending=False)
```

