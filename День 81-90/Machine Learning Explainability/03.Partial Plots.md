# Partial Plots
Графики частичной зависимости
В то время как важность функции показывает, какие переменные больше всего влияют на прогнозы, графики частичной 
зависимости показывают, как функция влияет на прогнозы. 

### Это полезно для ответов на такие вопросы, как:

С учетом всех других особенностей дома, какое влияние оказывают широта и долгота на цены на жилье? Чтобы еще раз 
сформулировать это, как будут оцениваться дома одинакового размера в разных районах? 

Являются ли предполагаемые различия в состоянии здоровья между двумя группами обусловлены различиями в их диетах или 
какими-то другими факторами? 

Если вы знакомы с моделями линейной или логистической регрессии, графики частичной зависимости можно 
интерпретировать аналогично коэффициентам в этих моделях. Однако графики частичной зависимости на сложных моделях 
могут отображать более сложные модели, чем коэффициенты на простых моделях. Если вы не знакомы с линейной или 
логистической регрессией, не беспокойтесь об этом сравнении.   

Мы покажем пару примеров, объясним интерпретацию этих графиков, а затем рассмотрим код для создания этих графиков.

### Как это работает
Как и важность перестановки, графики частичной зависимости рассчитываются после подбора модели. Модель соответствует 
реальным данным, которые не подвергались каким-либо искусственным манипуляциям. 

В нашем примере с футболом команды могут различаться по многим параметрам. Сколько передач они сделали, сколько 
бросков сделали, сколько голов забили и т. д. На первый взгляд кажется, что сложно распутать влияние этих особенностей. 

Чтобы увидеть, как частичные графики разделяют влияние каждой функции, мы начнем с рассмотрения одной строки данных. 
Например, этот ряд данных может представлять команду, которая владела мячом в 50 % случаев, сделала 100 передач, 
сделала 10 бросков и забила 1 гол.  

Мы будем использовать подобранную модель, чтобы предсказать наш результат (вероятность того, что их игрок выиграл 
«лучшего игрока матча»). Но мы неоднократно изменяем значение одной переменной, чтобы сделать серию прогнозов. Мы 
могли бы предсказать результат, если бы команда владела мячом только в 40% случаев. Затем мы прогнозируем, что они 
будут иметь мяч в 50% случаев. Затем предсказать снова на 60%. И так далее. Мы отслеживаем прогнозируемые результаты 
(по вертикальной оси) по мере перехода от малых значений владения мячом к большим значениям (по горизонтальной оси).    

В этом описании мы использовали только одну строку данных. Взаимодействия между функциями могут привести к тому, что 
график для одной строки будет нетипичным. Итак, мы повторяем этот мысленный эксперимент с несколькими строками из 
исходного набора данных и наносим средний прогнозируемый результат на вертикальную ось.  

### Пример кода
Построение модели не входит в нашу задачу, поэтому мы не будем фокусироваться на исследовании данных или коде 
построения модели. 
```python
import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.tree import DecisionTreeClassifier

data = pd.read_csv('../input/fifa-2018-match-statistics/FIFA 2018 Statistics.csv')
y = (data['Man of the Match'] == "Yes")  # Convert from string "Yes"/"No" to binary
feature_names = [i for i in data.columns if data[i].dtype in [np.int64]]
X = data[feature_names]
train_X, val_X, train_y, val_y = train_test_split(X, y, random_state=1)
tree_model = DecisionTreeClassifier(random_state=0, max_depth=5, min_samples_split=5).fit(train_X, train_y)
```
В нашем первом примере используется дерево решений, которое вы можете увидеть ниже. На практике вы будете 
использовать более сложные модели для реальных приложений.

```python
from sklearn import tree
import graphviz

tree_graph = tree.export_graphviz(tree_model, out_file=None, feature_names=feature_names)
graphviz.Source(tree_graph)
```
В качестве руководства для чтения дерева:

Листья с дочерними элементами показывают критерий разделения вверху.
Пара значений внизу показывает количество значений False и True для цели соответственно точек данных в этом узле дерева.
Вот код для создания графика частичной зависимости с использованием библиотеки PDPBox.

```python
from matplotlib import pyplot as plt
from pdpbox import pdp, get_dataset, info_plots

# Create the data that we will plot
pdp_goals = pdp.pdp_isolate(model=tree_model, dataset=val_X, model_features=feature_names, feature='Goal Scored')

# plot it
pdp.pdp_plot(pdp_goals, 'Goal Scored')
plt.show()
```

При интерпретации этого сюжета стоит обратить внимание на несколько моментов.

Ось y интерпретируется как изменение прогноза по сравнению с тем, что было бы предсказано для базового или крайнего левого значения.
Синяя заштрихованная область указывает на уровень достоверности
Из этого конкретного графика видно, что забитый гол существенно увеличивает ваши шансы на победу в «Лучшем игроке матча». Но дополнительные голы, помимо этого, похоже, мало влияют на прогнозы.

Вот еще пример сюжета:

```python
feature_to_plot = 'Distance Covered (Kms)'
pdp_dist = pdp.pdp_isolate(model=tree_model, dataset=val_X, model_features=feature_names, feature=feature_to_plot)

pdp.pdp_plot(pdp_dist, feature_to_plot)
plt.show()
```
Этот график кажется слишком простым, чтобы отображать реальность. Но это потому, что модель настолько проста. Вы 
должны увидеть из дерева решений выше, что оно точно представляет структуру модели. 

Вы можете легко сравнить структуру или последствия различных моделей. Вот тот же график с моделью Random Forest.
```python
# Build Random Forest model
rf_model = RandomForestClassifier(random_state=0).fit(train_X, train_y)

pdp_dist = pdp.pdp_isolate(model=rf_model, dataset=val_X, model_features=feature_names, feature=feature_to_plot)

pdp.pdp_plot(pdp_dist, feature_to_plot)
plt.show()
```

Эта модель считает, что у вас больше шансов стать Лучшим игроком матча, если ваши игроки пробегут в общей сложности 
100 км за игру. Хотя бег намного больше приводит к более низким прогнозам. 

В целом гладкая форма этой кривой кажется более правдоподобной, чем ступенчатая функция из модели дерева решений. 
Хотя этот набор данных достаточно мал, мы должны быть осторожны в интерпретации любой модели. 

### 2D-графики частичной зависимости
Если вам интересно узнать о взаимодействии между функциями, вам также пригодятся двухмерные графики частичной 
зависимости. Пример может прояснить это. 

Мы снова будем использовать модель дерева решений для этого графика. Это создаст очень простой сюжет, но вы сможете 
сопоставить то, что видите на графике, с самим деревом. 

```python
# Similar to previous PDP plot except we use pdp_interact instead of pdp_isolate and pdp_interact_plot instead of pdp_isolate_plot
features_to_plot = ['Goal Scored', 'Distance Covered (Kms)']
inter1  =  pdp.pdp_interact(model=tree_model, dataset=val_X, model_features=feature_names, features=features_to_plot)

pdp.pdp_interact_plot(pdp_interact_out=inter1, feature_names=features_to_plot, plot_type='contour')
plt.show()
```
На этом графике показаны прогнозы для любой комбинации забитых голов и пройденного расстояния.

Например, мы видим самые высокие прогнозы, когда команда забивает хотя бы 1 гол и пробегает общую дистанцию, близкую 
к 100 км. Если они забьют 0 голов, пройденное расстояние не имеет значения. Можете ли вы увидеть это, проследив 
дерево решений с 0 целями?  

Но расстояние может повлиять на прогнозы, если они забьют голы. Убедитесь, что вы видите это на графике частичной 
зависимости 2D. Вы тоже видите эту закономерность в дереве решений? 
