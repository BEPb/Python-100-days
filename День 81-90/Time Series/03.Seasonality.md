# Seasonality

### Что такое Сезонность?
Мы говорим, что временной ряд проявляет сезонность всякий раз, когда есть регулярное периодическое изменение 
среднего значения ряда. Сезонные изменения обычно следуют часам и календарю — обычно повторяются в течение дня, 
недели или года. Сезонность часто определяется циклами природного мира в течение дней и лет или условностями 
социального поведения, связанными с датами и временем.   


### Сезонные закономерности в четырех временных рядах.
Мы изучим два типа функций, которые моделируют сезонность. Первый вид, индикаторы, лучше всего подходит для сезона с 
небольшим количеством наблюдений, например еженедельного сезона ежедневных наблюдений. Второй тип, функции Фурье, 
лучше всего подходит для сезона с большим количеством наблюдений, например, для ежегодного сезона ежедневных наблюдений.

### Сезонные графики и сезонные индикаторы
Точно так же, как мы использовали график скользящего среднего, чтобы обнаружить тенденцию в ряду, мы можем 
использовать сезонный график, чтобы обнаружить сезонные закономерности. 

Сезонный график показывает сегменты временного ряда, построенные относительно некоторого общего периода, причем этот 
период является «сезоном», который вы хотите наблюдать. На рисунке показан сезонный график ежедневных просмотров 
статьи Википедии о тригонометрии: ежедневные просмотры статьи за обычный недельный период.  


В этом ряду есть четкая недельная сезонная закономерность: выше в будние дни и падает ближе к выходным.
### Сезонные показатели
Сезонные индикаторы — это бинарные функции, которые представляют сезонные различия в уровне временного ряда. 
Сезонные индикаторы — это то, что вы получите, если будете рассматривать сезонный период как категориальный признак 
и применять однократное кодирование.  

По однократному кодированию дней недели мы получаем недельные сезонные показатели. Создание еженедельных индикаторов 
для серии тригонометрии даст нам шесть новых «фиктивных» функций. (Линейная регрессия работает лучше всего, если вы 
отбрасываете один из индикаторов; мы выбрали понедельник в кадре ниже.)  
```commandline
Дата вторник среда четверг пятница суббота воскресенье
04.01.2016 0,0 0,0 0,0 0,0 0,0 0,0
05.01.2016 1,0 0,0 0,0 0,0 0,0 0,0
06.01.2016 0,0 1,0 0,0 0,0 0,0 0,0
07.01.2016 0,0 0,0 1,0 0,0 0,0 0,0
08.01.2016 0,0 0,0 0,0 1,0 0,0 0,0
09.01.2016 0,0 0,0 0,0 0,0 1,0 0,0
10.01.2016 0,0 0,0 0,0 0,0 0,0 1,0
11.01.2016 0,0 0,0 0,0 0,0 0,0 0,0
... ... ... ... ... ... ...
```

Добавление сезонных индикаторов к обучающим данным помогает моделям различать средние значения в пределах сезонного 
периода: 


### Обычная линейная регрессия изучает средние значения в каждый момент сезона.
Индикаторы действуют как переключатели Вкл/Выкл. В любой момент максимум один из этих индикаторов может иметь 
значение 1 (Вкл.). Линейная регрессия изучает базовое значение 2379 для понедельника, а затем корректирует значение 
того индикатора, который включен для этого дня; остальные равны 0 и исчезают.   

### Функции Фурье и периодограмма
Особенности, которые мы сейчас обсуждаем, лучше подходят для долгих сезонов по многим наблюдениям, где индикаторы 
были бы нецелесообразны. Вместо того, чтобы создавать функцию для каждой даты, функции Фурье пытаются зафиксировать 
общую форму сезонной кривой с помощью всего нескольких функций.  

Давайте посмотрим на график годового сезона в тригонометрии. Обратите внимание на повторения различной частоты: 
длинное движение вверх-вниз три раза в год, короткие еженедельные движения 52 раза в год и, возможно, другие. 


### Годовая сезонность в серии Вики-тригонометрии.
Именно эти частоты в течение сезона мы пытаемся зафиксировать с помощью признаков Фурье. Идея состоит в том, чтобы 
включить в наши обучающие данные периодические кривые, имеющие те же частоты, что и сезон, который мы пытаемся 
смоделировать. Мы используем кривые тригонометрических функций синуса и косинуса.  

Функции Фурье представляют собой пары синусоидальных и косинусоидальных кривых, по одной паре для каждой 
потенциальной частоты в сезоне, начиная с самого длинного. Пары Фурье, моделирующие годовую сезонность, будут иметь 
частоты: один раз в год, два раза в год, три раза в год и так далее.  

Верхний рисунок и нижний рисунок, каждый из которых показывает синусоидальную кривую и косинусоидальную кривую. Обе кривые на верхнем графике имеют частоту один раз в год, а обе кривые на нижнем графике имеют частоту два раза в год.
Первые две пары Фурье для годовой сезонности. Вверху: частота один раз в год. Внизу: частота два раза в год.
Если мы добавим набор этих синусоидальных/косинусоидальных кривых к нашим обучающим данным, алгоритм линейной регрессии вычислит веса, которые будут соответствовать сезонному компоненту в целевом ряду. На рисунке показано, как линейная регрессия использовала четыре пары Фурье для моделирования годовой сезонности в серии Wiki Trigonometry.


Вверху: кривые для четырех пар Фурье, сумма синуса и косинуса с коэффициентами регрессии. Каждая кривая моделирует другую частоту. Внизу: сумма этих кривых аппроксимирует сезонный характер.
Обратите внимание, что нам понадобилось всего восемь функций (четыре пары синус/косинус), чтобы получить хорошую 
оценку годовой сезонности. Сравните это с методом сезонных индикаторов, который потребовал бы сотни признаков (по одному на каждый день года). Моделируя только «основной эффект» сезонности с помощью функций Фурье, вы обычно вам нужно добавить гораздо меньше функций к вашим обучающим данным, что означает сокращение времени вычислений и меньший риск переобучения.

### Выбор функций Фурье с периодограммой
Сколько пар Фурье мы должны включить в наш набор функций? Мы можем ответить на этот вопрос с помощью периодограммы. 
Периодограмма показывает силу частот во временном ряду. В частности, значение по оси Y графика равно (a ** 2 + b ** 
2) / 2, где a и b — коэффициенты синуса и косинуса на этой частоте (как на графике компонентов Фурье выше). ).   


### Периодограмма для серии Вики-тригонометрии.
Слева направо периодограмма падает после Ежеквартально, четыре раза в год. Вот почему мы выбрали четыре пары Фурье 
для моделирования годового сезона. Недельную частоту мы игнорируем, так как она лучше моделируется индикаторами. 

### Вычисление функций Фурье (опционально)
Знание того, как вычисляются функции Фурье, не обязательно для их использования, но если просмотр деталей прояснит 
ситуацию, скрытая ячейка ниже иллюстрирует, как набор функций Фурье может быть получен из индекса временного ряда. 
(Однако мы будем использовать библиотечную функцию из statsmodels для наших приложений.)  
```python
import numpy as np


def fourier_features(index, freq, order):
    time = np.arange(len(index), dtype=np.float32)
    k = 2 * np.pi * (1 / freq) * time
    features = {}
    for i in range(1, order + 1):
        features.update({
            f"sin_{freq}_{i}": np.sin(i * k),
            f"cos_{freq}_{i}": np.cos(i * k),
        })
    return pd.DataFrame(features, index=index)


# Compute Fourier features to the 4th order (8 new features) for a
# series y with daily observations and annual seasonality:
#
# fourier_features(y, freq=365.25, order=4)
```


### Пример — туннельный трафик
Мы продолжим еще раз с набором данных Tunnel Traffic. Эта скрытая ячейка загружает данные и определяет две функции: 
сезонный_график и график_периодограммы. 
```python
from pathlib import Path
from warnings import simplefilter

import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
from sklearn.linear_model import LinearRegression
from statsmodels.tsa.deterministic import CalendarFourier, DeterministicProcess

simplefilter("ignore")

# Set Matplotlib defaults
plt.style.use("seaborn-whitegrid")
plt.rc("figure", autolayout=True, figsize=(11, 5))
plt.rc(
    "axes",
    labelweight="bold",
    labelsize="large",
    titleweight="bold",
    titlesize=16,
    titlepad=10,
)
plot_params = dict(
    color="0.75",
    style=".-",
    markeredgecolor="0.25",
    markerfacecolor="0.25",
    legend=False,
)
%config InlineBackend.figure_format = 'retina'


# annotations: https://stackoverflow.com/a/49238256/5769929
def seasonal_plot(X, y, period, freq, ax=None):
    if ax is None:
        _, ax = plt.subplots()
    palette = sns.color_palette("husl", n_colors=X[period].nunique(),)
    ax = sns.lineplot(
        x=freq,
        y=y,
        hue=period,
        data=X,
        ci=False,
        ax=ax,
        palette=palette,
        legend=False,
    )
    ax.set_title(f"Seasonal Plot ({period}/{freq})")
    for line, name in zip(ax.lines, X[period].unique()):
        y_ = line.get_ydata()[-1]
        ax.annotate(
            name,
            xy=(1, y_),
            xytext=(6, 0),
            color=line.get_color(),
            xycoords=ax.get_yaxis_transform(),
            textcoords="offset points",
            size=14,
            va="center",
        )
    return ax


def plot_periodogram(ts, detrend='linear', ax=None):
    from scipy.signal import periodogram
    fs = pd.Timedelta("1Y") / pd.Timedelta("1D")
    freqencies, spectrum = periodogram(
        ts,
        fs=fs,
        detrend=detrend,
        window="boxcar",
        scaling='spectrum',
    )
    if ax is None:
        _, ax = plt.subplots()
    ax.step(freqencies, spectrum, color="purple")
    ax.set_xscale("log")
    ax.set_xticks([1, 2, 4, 6, 12, 26, 52, 104])
    ax.set_xticklabels(
        [
            "Annual (1)",
            "Semiannual (2)",
            "Quarterly (4)",
            "Bimonthly (6)",
            "Monthly (12)",
            "Biweekly (26)",
            "Weekly (52)",
            "Semiweekly (104)",
        ],
        rotation=30,
    )
    ax.ticklabel_format(axis="y", style="sci", scilimits=(0, 0))
    ax.set_ylabel("Variance")
    ax.set_title("Periodogram")
    return ax


data_dir = Path("../input/ts-course-data")
tunnel = pd.read_csv(data_dir / "tunnel.csv", parse_dates=["Day"])
tunnel = tunnel.set_index("Day").to_period("D")
```
Давайте посмотрим на сезонные графики за неделю и за год.
```python
X = tunnel.copy()

# days within a week
X["day"] = X.index.dayofweek  # the x-axis (freq)
X["week"] = X.index.week  # the seasonal period (period)

# days within a year
X["dayofyear"] = X.index.dayofyear
X["year"] = X.index.year
fig, (ax0, ax1) = plt.subplots(2, 1, figsize=(11, 6))
seasonal_plot(X, y="NumVehicles", period="week", freq="day", ax=ax0)
seasonal_plot(X, y="NumVehicles", period="year", freq="dayofyear", ax=ax1);
```


Теперь давайте посмотрим на периодограмму:

```python
plot_periodogram(tunnel.NumVehicles);
```

Периодограмма согласуется с приведенными выше сезонными графиками: сильный недельный сезон и более слабый годовой 
сезон. Недельный сезон мы будем моделировать с помощью индикаторов, а годовой сезон — с помощью функций Фурье. 
Справа налево периодограмма падает между раз в два месяца (6) и ежемесячно (12), поэтому давайте используем 10 пар 
Фурье.   

Мы создадим наши сезонные объекты с помощью DefinisticProcess, той же утилиты, которую мы использовали в Уроке 2 для 
создания трендовых объектов. Чтобы использовать два сезонных периода (еженедельный и годовой), нам нужно создать 
экземпляр одного из них как «дополнительный термин»:  

```python
from statsmodels.tsa.deterministic import CalendarFourier, DeterministicProcess

fourier = CalendarFourier(freq="A", order=10)  # 10 sin/cos pairs for "A"nnual seasonality

dp = DeterministicProcess(
    index=tunnel.index,
    constant=True,               # dummy feature for bias (y-intercept)
    order=1,                     # trend (order 1 means linear)
    seasonal=True,               # weekly seasonality (indicators)
    additional_terms=[fourier],  # annual seasonality (fourier)
    drop=True,                   # drop terms to avoid collinearity
)

X = dp.in_sample()  # create features for dates in tunnel.index
```

Создав наш набор функций, мы готовы подогнать модель и сделать прогнозы. Мы добавим 90-дневный прогноз, чтобы 
увидеть, как наша модель экстраполирует данные за пределы обучающих данных. Код здесь такой же, как и в предыдущих 
уроках.  

```python
y = tunnel["NumVehicles"]

model = LinearRegression(fit_intercept=False)
_ = model.fit(X, y)

y_pred = pd.Series(model.predict(X), index=y.index)
X_fore = dp.out_of_sample(steps=90)
y_fore = pd.Series(model.predict(X_fore), index=X_fore.index)

ax = y.plot(color='0.25', style='.', title="Tunnel Traffic - Seasonal Forecast")
ax = y_pred.plot(ax=ax, label="Seasonal")
ax = y_fore.plot(ax=ax, label="Seasonal Forecast", color='C3')
_ = ax.legend()
```
Мы можем сделать еще больше с временными рядами, чтобы улучшить наши прогнозы. В следующем уроке мы узнаем, как 
использовать сами временные ряды в качестве признаков. Использование временных рядов в качестве входных данных для 
прогноза позволяет нам моделировать еще один компонент, часто встречающийся в рядах: циклы.   